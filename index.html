<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Tabs3 Time Capture</title>
<style>
  :root {
    --bg:#f4f6fb; --card:#fff; --ink:#101423; --muted:#5f6a7d;
    --brand:#153a77; --line:#e5eaf6; --soft:#f7f9ff;
    --danger:#b42318; --success:#0a7c42; --warn:#b45309;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--ink); }

  /* MODALS */
  .modal-overlay{ position:fixed; inset:0; background:rgba(10,15,30,.55); backdrop-filter:blur(4px); z-index:200; display:flex; align-items:center; justify-content:center; padding:16px; }
  .modal-overlay.hidden{ display:none; }
  .modal{ background:#fff; border-radius:20px; padding:28px 24px; max-width:420px; width:100%; box-shadow:0 24px 60px rgba(10,20,50,.22); }
  .modal h2{ margin:0 0 6px; font-size:20px; color:var(--brand); }
  .modal p{ margin:0 0 18px; color:var(--muted); font-size:14px; }
  .modal label{ display:block; font-size:12px; font-weight:900; color:#2a3550; margin-bottom:5px; margin-top:14px; }
  .modal input{ width:100%; font-size:16px; padding:12px; border-radius:12px; border:1px solid #d7deee; outline:none; }
  .modal input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(21,58,119,.13); }
  .modal .mactions{ margin-top:20px; display:flex; gap:10px; }
  .modal .mactions button{ flex:1; }
  .hint-text{ font-size:12px; color:var(--muted); margin-top:8px; line-height:1.4; }

  /* HEADER */
  header{ position:sticky; top:0; z-index:50; background:var(--brand); color:#fff; padding:12px 16px; box-shadow:0 2px 12px rgba(0,0,0,.18); }
  .hrow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  header h1{ margin:0; font-size:15px; font-weight:800; }
  .pills{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .pill{ font-size:12px; background:rgba(255,255,255,.18); padding:5px 10px; border-radius:999px; white-space:nowrap; }
  .pill b{ font-family:ui-monospace,monospace; }
  .pill.tap{ cursor:pointer; border:1px solid rgba(255,255,255,.3); }
  .pill.tap:hover,.pill.tap:active{ background:rgba(255,255,255,.28); }

  /* LAYOUT */
  main{ max-width:980px; margin:0 auto; padding:14px 16px 120px; }
  .card{ background:var(--card); border-radius:14px; padding:14px; box-shadow:0 2px 12px rgba(15,25,40,.06); margin-bottom:12px; border:1px solid rgba(229,234,246,.7); }
  .ctitle{ font-size:12px; font-weight:900; color:var(--brand); text-transform:uppercase; letter-spacing:.5px; margin-bottom:10px; }
  .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
  @media(min-width:820px){ .grid.two{ grid-template-columns:1fr 1fr; } .grid.three{ grid-template-columns:1fr 1fr 1fr; } }
  label{ display:block; font-size:12px; font-weight:900; color:#2a3550; margin-bottom:6px; }
  input,textarea,select,button{ width:100%; font-size:16px; padding:12px; border-radius:12px; border:1px solid #d7deee; outline:none; background:#fff; }
  textarea{ min-height:92px; resize:vertical; }
  input:focus,textarea:focus,select:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(21,58,119,.14); }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .row>*{ flex:1; min-width:130px; }
  .btn{ background:var(--brand); color:#fff; border:none; font-weight:900; cursor:pointer; }
  .btn:active{ opacity:.85; }
  .btn.sec{ background:var(--soft); color:var(--brand); border:1px solid #d6ddff; }
  .btn.danger{ background:var(--danger); color:#fff; border:none; }
  .small{ font-size:12px; color:var(--muted); line-height:1.4; }
  .divider{ height:1px; background:#eef1f8; margin:12px 0; }
  .mono{ font-family:ui-monospace,monospace; }

  /* STATUS BARS */
  .sbar{ font-size:12px; padding:8px 12px; border-radius:10px; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
  .sbar.ok{ background:#e8f7ef; color:var(--success); border:1px solid #b2e4ca; }
  .sbar.warn{ background:#fef3e2; color:var(--warn); border:1px solid #fcd88a; }
  .sbar.err{ background:#fdecea; color:var(--danger); border:1px solid #f5b7b1; }
  .sdot{ width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .sbar.ok .sdot{ background:var(--success); }
  .sbar.warn .sdot{ background:var(--warn); }
  .sbar.err .sdot{ background:var(--danger); }

  /* SEARCH */
  .swrap{ position:relative; }
  .dd{ position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff; border:1px solid #d7deee; border-radius:14px; overflow:hidden; box-shadow:0 14px 36px rgba(20,30,55,.18); display:none; max-height:300px; overflow-y:auto; z-index:100; }
  .opt{ padding:12px 14px; border-bottom:1px solid #f0f2f8; cursor:pointer; min-height:52px; }
  .opt:last-child{ border-bottom:none; }
  .opt:hover,.opt:active{ background:#f2f6ff; }
  .opt .otop{ font-weight:900; font-size:14px; }
  .opt .omid{ font-size:13px; color:#28324a; margin-top:2px; }
  .opt .obot{ font-size:12px; color:#667; margin-top:2px; }

  /* ENTRIES */
  .entry{ border:1px solid var(--line); background:#fff; border-radius:14px; padding:12px; margin-top:10px; }
  .emeta{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .badges{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
  .badge{ font-size:12px; border:1px solid var(--line); background:var(--soft); padding:4px 8px; border-radius:999px; }
  .ubadge{ background:#eef2ff; border-color:#c7d2fe; color:#3730a3; }
  .edesc{ margin-top:8px; white-space:pre-wrap; font-size:14px; }
  .eactions{ margin-top:10px; display:flex; gap:8px; }
  .eactions button{ padding:10px; font-size:14px; border-radius:12px; }

  /* FOOTER */
  footer{ position:fixed; left:0; right:0; bottom:0; background:rgba(244,246,251,.94); backdrop-filter:blur(10px); border-top:1px solid #e8ecf8; }
  footer .wrap{ max-width:980px; margin:0 auto; padding:10px 14px; display:flex; gap:8px; flex-wrap:wrap; }
  footer .wrap button{ border-radius:14px; flex:1; min-width:0; }

  /* TABS */
  .tabs{ display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap; }
  .tbtn{ padding:9px 16px; border-radius:12px; border:1px solid #d7deee; background:var(--soft); color:var(--muted); font-weight:700; font-size:13px; cursor:pointer; width:auto; }
  .tbtn.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
  .tcontent{ display:none; }
  .tcontent.active{ display:block; }

  /* QUICK */
  .quick{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .quick button{ flex:none; width:auto; padding:8px 14px; font-size:14px; border-radius:10px; }
</style>
</head>
<body>

<!-- PASSWORD MODAL -->
<div id="pwModal" class="modal-overlay">
  <div class="modal">
    <h2>üîí Firm Access</h2>
    <p>Enter the firm password to continue.</p>
    <label>Password</label>
    <input id="pwInput" type="password" placeholder="Enter password" />
    <div id="pwErr" style="display:none;color:var(--danger);font-size:13px;margin-top:8px;">Incorrect password.</div>
    <div class="mactions"><button class="btn" onclick="submitPW()">Unlock</button></div>
  </div>
</div>

<!-- USER SETUP MODAL -->
<div id="setupModal" class="modal-overlay hidden">
  <div class="modal">
    <h2>üë§ Your Profile</h2>
    <p>Set your name and timekeeper code. Tap your name in the header anytime to change it.</p>
    <label>Your Name</label>
    <input id="setupName" type="text" placeholder="e.g. Michael Mackey" autocomplete="name" />
    <label>Timekeeper Code</label>
    <input id="setupTK" type="text" inputmode="numeric" placeholder="e.g. 70" autocomplete="off" />
    <div class="hint-text">Your TK code is automatically added to every Tabs3 CSV export.</div>
    <div class="mactions"><button class="btn" onclick="saveProfile()">Save & Continue</button></div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div id="editModal" class="modal-overlay hidden">
  <div class="modal">
    <h2>‚úèÔ∏è Edit Profile</h2>
    <p>Update your name or timekeeper code.</p>
    <label>Your Name</label>
    <input id="editName" type="text" autocomplete="name" />
    <label>Timekeeper Code</label>
    <input id="editTK" type="text" inputmode="numeric" autocomplete="off" />
    <div class="mactions">
      <button class="btn" onclick="saveEditProfile()">Save</button>
      <button class="btn sec" onclick="closeModal('editModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="hrow">
    <h1>‚öñÔ∏è Tabs3 Time Capture</h1>
    <div class="pills">
      <div class="pill tap" id="userPill" onclick="openEditProfile()" title="Tap to edit">
        üë§ <span id="pillName">‚Äî</span> ¬∑ TK <b id="pillTK">‚Äî</b>
      </div>
      <div class="pill" id="pillCount">0 today</div>
      <div class="pill" id="pillHours">0.0 hrs</div>
    </div>
  </div>
</header>

<main>
<div class="tabs">
  <button class="tbtn active" onclick="showTab('entry')">‚è± Enter Time</button>
  <button class="tbtn" onclick="showTab('review')">üìã Review</button>
  <button class="tbtn" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
</div>

<!-- TAB: ENTRY -->
<div id="t-entry" class="tcontent active">

  <div class="card">
    <div class="ctitle">Client / Matter</div>
    <div id="listBar" class="sbar warn" style="display:none;"><div class="sdot"></div><span id="listBarText"></span></div>

    <div class="grid two" style="margin-bottom:10px;">
      <div><label>Recents</label><select id="recents"></select></div>
      <div><label>Favorites</label><select id="favorites"></select></div>
    </div>

    <label>Search / Dictate</label>
    <div class="swrap">
      <input id="mSearch" type="text" inputmode="text" autocomplete="off" autocapitalize="none"
        autocorrect="off" spellcheck="false"
        placeholder='Type name, matter, or ID‚Ä¶ e.g. "PMG" or "11015"' />
      <div id="dd" class="dd"></div>
    </div>

    <div style="margin-top:10px;">
      <div class="small">Selected:</div>
      <div id="selLine" style="font-weight:900;font-size:15px;margin-top:4px;color:var(--brand);">None</div>
      <input type="hidden" id="selId" />
      <div class="row" style="margin-top:10px;">
        <button class="btn sec" id="focusDescBtn">üé§ Focus Description</button>
        <button class="btn sec" id="addFavBtn">‚≠ê Favorite</button>
        <button class="btn sec" id="clearSelBtn">‚úï Clear</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">Time Entry</div>
    <div class="grid two">
      <div>
        <label>Description</label>
        <textarea id="desc" placeholder="Dictate or type work description‚Ä¶"></textarea>
      </div>
      <div class="grid">
        <div class="grid two">
          <div><label>Hours</label><input id="hours" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 0.3" /></div>
          <div><label>Date</label><input id="workDate" type="date" /></div>
        </div>
        <div>
          <label>Quick Add</label>
          <div class="quick">
            <button class="btn sec" onclick="addH(0.1)">+0.1</button>
            <button class="btn sec" onclick="addH(0.2)">+0.2</button>
            <button class="btn sec" onclick="addH(0.3)">+0.3</button>
            <button class="btn sec" onclick="addH(0.5)">+0.5</button>
            <button class="btn sec" onclick="addH(1.0)">+1.0</button>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="addBtn">‚ûï Add Entry</button>
          <button class="btn sec" id="dupBtn">üìã Dup Yesterday</button>
        </div>
        <div class="small">Tip: Select matter first, then dictate description.</div>
      </div>
    </div>
  </div>
</div>

<!-- TAB: REVIEW -->
<div id="t-review" class="tcontent">
  <div class="card">
    <div class="ctitle">Daily Review</div>
    <div class="grid three">
      <div>
        <label>Review Date</label>
        <input id="reviewDate" type="date" />
        <div class="small" style="margin-top:5px;">Edit/delete for this date.</div>
      </div>
      <div>
        <label>Day Total</label>
        <input id="totalHours" readonly />
        <div class="small" style="margin-top:5px;">Entries: <span id="totalEntries">0</span></div>
      </div>
      <div>
        <label>Week Total (Mon‚ÄìSun)</label>
        <input id="weekHours" readonly />
        <div class="small" style="margin-top:5px;"><span id="weekRange">‚Äî</span></div>
      </div>
    </div>
    <div class="divider"></div>
    <div id="entriesList"></div>
    <div class="divider"></div>
    <button class="btn danger" id="clearAllBtn">üóë Clear ALL Entries (this device)</button>
  </div>
</div>

<!-- TAB: SETTINGS -->
<div id="t-settings" class="tcontent">

  <div class="card">
    <div class="ctitle">üìã Client List Status</div>
    <div id="csvStatusBar" class="sbar warn"><div class="sdot"></div><span id="csvStatusText">Loading matters.csv from server‚Ä¶</span></div>
    <p class="small">
      The client list loads automatically from <span class="mono">matters.csv</span> in the GitHub repo ‚Äî
      no setup needed. To update the firm list, replace <span class="mono">matters.csv</span> in GitHub and it will be live for everyone within ~30 seconds.
    </p>
    <button class="btn sec" onclick="reloadMatters()">üîÑ Reload Client List Now</button>
    <div class="divider"></div>
    <label>Manual Override <span class="small">(this device only)</span></label>
    <input id="csvFile" type="file" accept=".csv,.txt,.exp,text/csv,text/plain" />
    <div id="importMsg" class="small" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div class="ctitle">üì§ Export Format</div>
    <div class="grid two">
      <div>
        <label>Preset</label>
        <select id="exportPreset">
          <option value="tabs3like">Tabs3: Date, Timekeeper, ClientMatterID, Hours, Narrative</option>
          <option value="simple">Simple: Date, Timekeeper, Matter, Hours, Description</option>
          <option value="custom">Custom Header (edit below)</option>
        </select>
      </div>
      <div>
        <label>Custom Header</label>
        <input id="customHeader" placeholder="Date,Timekeeper,Matter,Hours,Description" />
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">üíæ Backup & Restore</div>
    <p class="small" style="margin-bottom:10px;">Each user backs up their own entries on their device.</p>
    <div class="row">
      <button class="btn sec" id="backupBtn">‚¨áÔ∏è Download Backup</button>
      <label class="btn sec" style="display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0;">
        ‚¨ÜÔ∏è Restore Backup
        <input id="restoreFile" type="file" accept=".json" style="display:none;">
      </label>
    </div>
  </div>

</div>
</main>

<footer>
  <div class="wrap">
    <button class="btn" id="exportDay">Export Today</button>
    <button class="btn sec" id="exportReview">Export Review Date</button>
    <button class="btn sec" id="exportRange">Export Range</button>
  </div>
</footer>

<script>
/* ‚îÄ‚îÄ FIRM CONFIG ‚îÄ‚îÄ */
const FIRM_PW = "MCWtime";   // ‚Üê change password here

/* ‚îÄ‚îÄ STORAGE KEYS ‚îÄ‚îÄ */
const LS = {
  matters:"tabs3_matters_v3", entries:"tabs3_entries_v3",
  recents:"tabs3_recents_v3", favorites:"tabs3_favorites_v3",
  settings:"tabs3_settings_v3", user:"tabs3_user_v1",
  auth:"tabs3_auth_v1"
};

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
const $=id=>document.getElementById(id);
function loadJ(k,fb){try{return JSON.parse(localStorage.getItem(k)||"")??fb;}catch{return fb;}}
function saveJ(k,v){localStorage.setItem(k,JSON.stringify(v));}
function todayISO(){const d=new Date();return new Date(d-d.getTimezoneOffset()*60000).toISOString().slice(0,10);}
function norm(s){return(s||"").toLowerCase().replace(/[^\w\s.\-]/g," ").replace(/\s+/g," ").trim();}
function esc(s){return(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");}
function csvQ(s){return`"${(s??"").toString().replace(/"/g,'""')}"}`;}
function uid(){return crypto?.randomUUID?.()??(Date.now()+"_"+Math.random().toString(16).slice(2));}
function monISO(iso){const d=new Date(iso+"T12:00:00");d.setDate(d.getDate()-(d.getDay()===0?6:d.getDay()-1));return isoFrom(d);}
function isoFrom(d){return new Date(d-d.getTimezoneOffset()*60000).toISOString().slice(0,10);}
function closeModal(id){$(id).classList.add("hidden");}
function openModal(id){$(id).classList.remove("hidden");}

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let matters   = loadJ(LS.matters,   []);
let entries   = loadJ(LS.entries,   []);
let recents   = loadJ(LS.recents,   []);
let favorites = loadJ(LS.favorites, []);
let settings  = loadJ(LS.settings,  {timekeeper:"70"});
let user      = loadJ(LS.user,      null);

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
function submitPW(){
  if($("pwInput").value===FIRM_PW){saveJ(LS.auth,"ok");closeModal("pwModal");onAuth();}
  else{$("pwErr").style.display="block";$("pwInput").value="";$("pwInput").focus();}
}
$("pwInput").addEventListener("keydown",e=>{if(e.key==="Enter")submitPW();});
function checkAuth(){if(loadJ(LS.auth,null)==="ok"){closeModal("pwModal");onAuth();}}
function onAuth(){if(!user?.name)openModal("setupModal");else boot();}

/* ‚îÄ‚îÄ USER PROFILE ‚îÄ‚îÄ */
function saveProfile(){
  const name=($("setupName").value||"").trim();
  const tk=($("setupTK").value||"").trim()||"70";
  if(!name){alert("Please enter your name.");return;}
  user={name,timekeeper:tk};saveJ(LS.user,user);closeModal("setupModal");boot();
}
$("setupTK").addEventListener("keydown",e=>{if(e.key==="Enter")saveProfile();});
function openEditProfile(){$("editName").value=user?.name||"";$("editTK").value=user?.timekeeper||"70";openModal("editModal");}
function saveEditProfile(){
  const name=($("editName").value||"").trim();
  const tk=($("editTK").value||"").trim()||"70";
  if(!name){alert("Name required.");return;}
  user={name,timekeeper:tk};saveJ(LS.user,user);closeModal("editModal");renderHeader();
}
function safeTK(){const r=(user?.timekeeper||settings?.timekeeper||"70").toString();const m=r.match(/(\d+)/);return m?m[1]:"70";}
function renderHeader(){$("pillName").textContent=user?.name||"Set profile";$("pillTK").textContent=safeTK();}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function showTab(name){
  document.querySelectorAll(".tcontent").forEach(e=>e.classList.remove("active"));
  document.querySelectorAll(".tbtn").forEach(e=>e.classList.remove("active"));
  $("t-"+name).classList.add("active");
  document.querySelector(`[onclick="showTab('${name}')"]`).classList.add("active");
  if(name==="review")renderReview();
}

/* ‚îÄ‚îÄ DATES ‚îÄ‚îÄ */
function initDates(){
  const t=todayISO();
  if(!$("workDate").value||$("workDate").value<t)$("workDate").value=t;
  if(!$("reviewDate").value)$("reviewDate").value=t;
}
setInterval(()=>{const t=todayISO();if($("workDate").value<t)$("workDate").value=t;},60000);

/* ‚îÄ‚îÄ LOAD MATTERS FROM matters.csv IN REPO ‚îÄ‚îÄ */
function parseMattersText(text){
  const parsed=parseCSV(text);
  if(!parsed.rows.length)return[];
  const hdrs=parsed.headers.map(h=>norm(h));
  const idx=(...ns)=>{for(const n of ns){const i=hdrs.indexOf(norm(n));if(i>=0)return i;}return -1;};
  const idI=idx("client id","clientid","id","tabs3 id","clientmatterid","client/matter id","clientmatter");
  const cnI=idx("client name","client","clientname","name");
  const mdI=idx("matter","matter description","matterdesc","description","matter desc");
  if(idI<0)return[];
  const out=[];
  for(const r of parsed.rows){
    const full_id=(r[idI]||"").trim();
    if(!full_id||!full_id.includes("."))continue;
    const[client_id,matter_id]=full_id.split(".");
    const client_name=cnI>=0?(r[cnI]||"").trim():"";
    const matter_desc=mdI>=0?(r[mdI]||"").trim():"";
    out.push({full_id,client_id,matter_id,client_name,matter_desc,
              search_text:norm(`${full_id} ${client_id} ${matter_id} ${client_name} ${matter_desc}`)});
  }
  return out;
}

async function loadMattersFromRepo(){
  try{
    const res=await fetch("./matters.csv",{cache:"no-store"});
    if(!res.ok)throw new Error("not found");
    const text=await res.text();
    const nm=parseMattersText(text);
    if(!nm.length)throw new Error("no valid rows");
    matters=nm;saveJ(LS.matters,matters);
    setCsvStatus("ok",`‚úÖ ${matters.length} client/matter records loaded from matters.csv`);
    return true;
  }catch(e){
    if(matters.length){
      setCsvStatus("warn",`Using cached list (${matters.length} records). Could not fetch latest matters.csv.`);
    }else{
      setCsvStatus("err","Could not load matters.csv ‚Äî add it to your GitHub repo root.");
    }
    return false;
  }
}

async function reloadMatters(){
  setCsvStatus("warn","Reloading‚Ä¶");
  await loadMattersFromRepo();
  renderRF();updateListBar();
}

function setCsvStatus(t,msg){
  const bar=$("csvStatusBar");
  bar.className=`sbar ${t}`;
  $("csvStatusText").textContent=msg;
}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
function score(q,m){
  if(!q)return 0;
  const st=norm(`${m.full_id} ${m.client_id||""} ${m.matter_id||""} ${m.client_name||""} ${m.matter_desc||""}`);
  if(m.full_id?.startsWith(q))return 2000;
  const cn=norm(m.client_name||""),md=norm(m.matter_desc||"");
  if(cn.startsWith(q))return 1200;
  if(md.startsWith(q))return 1100;
  if(st.includes(q))return 700;
  let s=0;
  for(const t of q.split(" ").filter(t=>t.length>=2)){
    if(m.full_id?.includes(t))s+=120;
    if(cn.includes(t))s+=90;
    if(md.includes(t))s+=80;
    else if(st.includes(t))s+=40;
  }
  return s;
}
let dbt=null;
$("mSearch").addEventListener("input",()=>{clearTimeout(dbt);dbt=setTimeout(runSearch,100);});
function runSearch(){
  const q=norm($("mSearch").value),dd=$("dd");
  if(!q||!matters.length){dd.style.display="none";return;}
  const hits=matters.map(m=>({m,s:score(q,m)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,10);
  if(!hits.length){dd.style.display="none";return;}
  dd.innerHTML=hits.map(({m})=>`
    <div class="opt" onclick="pickM('${esc(m.full_id)}')" ontouchend="pickM('${esc(m.full_id)}')">
      <div class="otop">${esc(m.client_name||"‚Äî")}</div>
      <div class="omid">${esc(m.matter_desc||"‚Äî")}</div>
      <div class="obot mono">${esc(m.full_id)}</div>
    </div>`).join("");
  dd.style.display="block";
}
function pickM(id){const m=matters.find(x=>x.full_id===id);if(m){selM(m);$("dd").style.display="none";$("mSearch").value="";}}
function selM(m){
  $("selId").value=m.full_id;
  $("selLine").textContent=`${m.full_id} ¬∑ ${m.client_name} ‚Äî ${m.matter_desc}`;
  recents=[m.full_id,...recents.filter(x=>x!==m.full_id)].slice(0,20);
  saveJ(LS.recents,recents);renderRF();
}
function idLabel(id){const m=matters.find(x=>x.full_id===id);return m?`${id} ¬∑ ${m.client_name} ‚Äî ${m.matter_desc}`:id;}
document.addEventListener("click",e=>{if(!e.target.closest(".swrap"))$("dd").style.display="none";});

/* ‚îÄ‚îÄ RECENTS / FAVORITES ‚îÄ‚îÄ */
function renderRF(){
  const rs=$("recents"),fs=$("favorites");
  rs.innerHTML="";fs.innerHTML="";
  rs.appendChild(new Option(matters.length?"Select a recent‚Ä¶":"Loading‚Ä¶",""));
  recents.forEach(id=>rs.appendChild(new Option(idLabel(id),id)));
  fs.appendChild(new Option(favorites.length?"Select a favorite‚Ä¶":"No favorites yet",""));
  favorites.forEach(id=>fs.appendChild(new Option(idLabel(id),id)));
}
$("recents").addEventListener("change",function(){const m=matters.find(x=>x.full_id===this.value);if(m){selM(m);this.value="";}});
$("favorites").addEventListener("change",function(){const m=matters.find(x=>x.full_id===this.value);if(m){selM(m);this.value="";}});
$("addFavBtn").addEventListener("click",()=>{
  const id=$("selId").value;if(!id)return alert("Select a matter first.");
  favorites=[id,...favorites.filter(x=>x!==id)].slice(0,40);saveJ(LS.favorites,favorites);renderRF();
});
$("clearSelBtn").addEventListener("click",()=>{$("selId").value="";$("selLine").textContent="None";});
$("focusDescBtn").addEventListener("click",()=>{$("desc").focus();$("desc").scrollIntoView({behavior:"smooth",block:"center"});});

/* ‚îÄ‚îÄ ENTRIES ‚îÄ‚îÄ */
function addH(n){$("hours").value=(Math.round((Number($("hours").value||0)+n)*10)/10).toFixed(1);}
function mkEntry(date,matterId,desc,hrs){
  const m=matters.find(x=>x.full_id===matterId);
  entries.unshift({id:uid(),date,timekeeper:safeTK(),user_name:user?.name||"",
    matter_full_id:matterId,client_name:m?.client_name||"",matter_desc:m?.matter_desc||"",
    hours:Number(hrs),description:(desc||"").trim(),created_at:Date.now()});
}
$("addBtn").addEventListener("click",()=>{
  const id=$("selId").value,d=($("desc").value||"").trim(),h=$("hours").value,dt=$("workDate").value||todayISO();
  if(!id)return alert("Select a Client/Matter first.");
  if(!d)return alert("Add a description.");
  if(!h||Number(h)<=0)return alert("Enter valid hours (e.g. 0.3).");
  mkEntry(dt,id,d,h);saveJ(LS.entries,entries);
  $("desc").value="";$("hours").value="";$("desc").focus();renderPills();
});
$("dupBtn").addEventListener("click",()=>{
  const t=todayISO(),y=isoFrom(new Date(new Date(t+"T12:00:00").getTime()-86400000));
  const ye=entries.filter(e=>e.date===y);
  if(!ye.length)return alert("No entries for yesterday.");
  if(!confirm(`Duplicate ${ye.length} entries from ${y} to today?`))return;
  [...ye].sort((a,b)=>(a.created_at||0)-(b.created_at||0)).forEach(e=>mkEntry(t,e.matter_full_id,e.description,e.hours));
  saveJ(LS.entries,entries);$("workDate").value=t;renderPills();
});
window.delEntry=function(id){if(!confirm("Delete this entry?"))return;entries=entries.filter(e=>e.id!==id);saveJ(LS.entries,entries);renderReview();renderPills();};
window.editEntry=function(id){
  const e=entries.find(x=>x.id===id);if(!e)return;
  const nd=prompt("Edit description:",e.description);if(nd===null)return;
  const nh=prompt("Edit hours:",String(e.hours));if(nh===null)return;
  const h=Number(nh);
  if(!nd.trim())return alert("Description required.");
  if(!h||isNaN(h)||h<=0)return alert("Hours must be > 0.");
  e.description=nd.trim();e.hours=h;saveJ(LS.entries,entries);renderReview();renderPills();
};

/* ‚îÄ‚îÄ REVIEW ‚îÄ‚îÄ */
$("reviewDate").addEventListener("change",()=>{renderReview();renderPills();});
function renderReview(){
  const dt=$("reviewDate").value||todayISO(),list=entries.filter(e=>e.date===dt);
  let tot=0;list.forEach(e=>tot+=Number(e.hours||0));
  $("totalHours").value=tot.toFixed(1);$("totalEntries").textContent=list.length;
  const mon=monISO(dt),sun=isoFrom(new Date(new Date(mon+"T12:00:00").getTime()+6*86400000));
  $("weekRange").textContent=`${mon} ‚Üí ${sun}`;
  let wt=0;entries.filter(e=>e.date>=mon&&e.date<=sun).forEach(e=>wt+=Number(e.hours||0));
  $("weekHours").value=wt.toFixed(1);
  const el=$("entriesList");
  if(!list.length){el.innerHTML=`<div class="small" style="text-align:center;padding:20px;">No entries for ${esc(dt)}.</div>`;return;}
  el.innerHTML="";
  for(const e of list){
    const d=document.createElement("div");d.className="entry";
    d.innerHTML=`
      <div class="emeta">
        <div class="badges">
          <span class="badge mono"><b>${esc(e.matter_full_id)}</b></span>
          <span class="badge">${Number(e.hours).toFixed(1)} hrs</span>
          <span class="badge">TK ${esc(e.timekeeper||safeTK())}</span>
          ${e.user_name?`<span class="badge ubadge">üë§ ${esc(e.user_name)}</span>`:""}
        </div>
        <div class="small">${esc(e.client_name)} ‚Äî ${esc(e.matter_desc)}</div>
      </div>
      <div class="edesc">${esc(e.description)}</div>
      <div class="eactions">
        <button class="btn sec" onclick="editEntry('${e.id}')">‚úèÔ∏è Edit</button>
        <button class="btn danger" onclick="delEntry('${e.id}')">üóë Delete</button>
      </div>`;
    el.appendChild(d);
  }
}
function renderPills(){
  const t=todayISO(),list=entries.filter(e=>e.date===t);
  let tot=0;list.forEach(e=>tot+=Number(e.hours||0));
  $("pillCount").textContent=`${list.length} today`;$("pillHours").textContent=`${tot.toFixed(1)} hrs`;
}
$("clearAllBtn").addEventListener("click",()=>{
  if(!confirm("Clear ALL entries on this device? Back up first!"))return;
  entries=[];saveJ(LS.entries,entries);renderReview();renderPills();
});

/* ‚îÄ‚îÄ MATTER STATUS (entry tab) ‚îÄ‚îÄ */
function updateListBar(){
  const bar=$("listBar"),txt=$("listBarText");bar.style.display="flex";
  if(!matters.length){bar.className="sbar warn";txt.textContent="No client list loaded ‚Äî check Settings.";}
  else{bar.className="sbar ok";txt.textContent=`${matters.length} client/matter records loaded.`;}
}

/* ‚îÄ‚îÄ MANUAL CSV OVERRIDE ‚îÄ‚îÄ */
$("csvFile").addEventListener("change",async function(){
  const file=this.files?.[0];if(!file)return;
  const text=await file.text();
  const nm=parseMattersText(text);
  if(!nm.length)return alert("No valid rows found. Check that Client ID column has IDs like 11015.0001.");
  matters=nm;saveJ(LS.matters,matters);renderRF();updateListBar();
  $("importMsg").innerHTML=`<span style="color:var(--success);">‚úÖ Imported ${matters.length} matters from ${esc(file.name)} (this device only).</span>`;
  this.value="";
});

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
function hdr(p){
  if(p==="tabs3like")return"Date,Timekeeper,ClientMatterID,Hours,Narrative";
  if(p==="simple")return"Date,Timekeeper,Matter,Hours,Description";
  return($("customHeader").value||"").trim()||"Date,Timekeeper,Matter,Hours,Description";
}
function doExport(list,fname){
  if(!list.length)return alert("No entries to export.");
  let csv=hdr($("exportPreset").value)+"\n";
  for(const e of list)csv+=[e.date,e.timekeeper||safeTK(),e.matter_full_id,Number(e.hours).toFixed(1),csvQ(e.description)].join(",")+"\n";
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob),a=document.createElement("a");
  a.href=url;a.download=fname;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
}
$("exportDay").addEventListener("click",()=>doExport(entries.filter(e=>e.date===todayISO()),`tabs3_${todayISO()}.csv`));
$("exportReview").addEventListener("click",()=>{const dt=$("reviewDate").value||todayISO();doExport(entries.filter(e=>e.date===dt),`tabs3_${dt}.csv`);});
$("exportRange").addEventListener("click",()=>{
  const s=prompt("Start date (YYYY-MM-DD):",todayISO());if(!s)return;
  const e=prompt("End date (YYYY-MM-DD):",todayISO());if(!e)return;
  doExport(entries.filter(x=>x.date>=s&&x.date<=e),`tabs3_${s}_to_${e}.csv`);
});

/* ‚îÄ‚îÄ BACKUP / RESTORE ‚îÄ‚îÄ */
$("backupBtn").addEventListener("click",()=>{
  const p={version:3,exported_at:new Date().toISOString(),user,matters,entries,recents,favorites,settings};
  const blob=new Blob([JSON.stringify(p,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob),a=document.createElement("a");
  a.href=url;a.download=`tabs3_${(user?.name||"user").replace(/\s/g,"_")}_${todayISO()}.json`;
  document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
});
$("restoreFile").addEventListener("change",async function(){
  const file=this.files?.[0];if(!file)return;
  try{
    const obj=JSON.parse(await file.text());
    if(!confirm("Restore will overwrite your data. Continue?"))return;
    if(Array.isArray(obj.matters)){matters=obj.matters;saveJ(LS.matters,matters);}
    if(Array.isArray(obj.entries)){entries=obj.entries;saveJ(LS.entries,entries);}
    if(Array.isArray(obj.recents)){recents=obj.recents;saveJ(LS.recents,recents);}
    if(Array.isArray(obj.favorites)){favorites=obj.favorites;saveJ(LS.favorites,favorites);}
    if(obj.settings){settings=obj.settings;saveJ(LS.settings,settings);}
    if(obj.user){user=obj.user;saveJ(LS.user,user);renderHeader();}
    renderRF();renderReview();renderPills();updateListBar();alert("Restore complete.");
  }catch{alert("Could not restore file.");}
  finally{this.value="";}
});

/* ‚îÄ‚îÄ CSV PARSER (auto-detects comma or tab) ‚îÄ‚îÄ */
function parseCSV(text){
  const firstLine=text.split("\n")[0]||"";
  const delim=(firstLine.split("\t").length>firstLine.split(",").length)?"\t":",";
  const rows=[];let cur=[],val="",inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],nx=text[i+1];
    if(inQ){if(c==='"'&&nx==='"'){val+='"';i++;}else if(c==='"')inQ=false;else val+=c;}
    else{if(c==='"')inQ=true;else if(c===delim){cur.push(val);val="";}else if(c==="\n"){cur.push(val);rows.push(cur);cur=[];val="";}else if(c!=="\r")val+=c;}
  }
  cur.push(val);if(cur.length>1||cur[0].trim())rows.push(cur);
  const headers=(rows.shift()||[]).map(h=>(h||"").trim());
  return{headers,rows};
}

/* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ */
async function boot(){
  initDates();renderHeader();

  // URL param: ?tk=71 lets you set TK via a link
  const tkParam=new URLSearchParams(location.search).get("tk");
  if(tkParam&&/^\d+$/.test(tkParam)){user={...user,timekeeper:tkParam};saveJ(LS.user,user);renderHeader();}

  await loadMattersFromRepo();
  renderRF();updateListBar();renderReview();renderPills();
  $("customHeader").value="Date,Timekeeper,Matter,Hours,Description";
}

checkAuth();
</script>
</body>
</html>

